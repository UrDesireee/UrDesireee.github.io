<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Bunny's Yesstyle Collection</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/animations.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <a href="index.html">
                <span class="bunny-emoji">üê∞</span>
                Bunny's Yesstyle
                <span class="bunny-emoji">üê∞</span>
            </a>
        </div>
        <div class="nav-links">
            <a href="index.html">View Site</a>
            <a href="#" id="logoutBtn" class="admin-login">Logout</a>
        </div>
    </nav>

    <div class="admin-dashboard">
        <div class="admin-panel">
            <div class="admin-header">
                <h2>üê∞ Admin Dashboard</h2>
                <div class="admin-nav">
                    <button class="admin-nav-btn active" data-tab="add">Add Product</button>
                    <button class="admin-nav-btn" data-tab="manage">Manage Products</button>
                </div>
            </div>

            <div class="admin-content">
                <div id="addProductTab" class="admin-tab active">
                    <form id="productForm">
                        <div class="form-group">
                            <label for="productName">Product Name</label>
                            <input type="text" id="productName" placeholder="Enter cute product name" required>
                        </div>
                        <div class="form-group">
                            <label for="productCategory">Category</label>
                            <div class="category-selection">
                                <select id="productCategory" required>
                                    <option value="">Select a category</option>
                                    <!-- Categories will be loaded dynamically -->
                                </select>
                                <button type="button" class="add-category-btn" onclick="showNewCategoryInput()">
                                    <span class="button-icon">‚ûï</span> New Category
                                </button>
                            </div>
                            <div id="newCategoryInput" class="add-category-form" style="display: none;">
                                <input type="text" id="newCategory" placeholder="Enter new category name">
                                <button type="button" onclick="addNewCategory()">Add</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="productPrice">Price ($)</label>
                            <input type="number" id="productPrice" placeholder="0.00" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="productImage">Image URL</label>
                            <input type="url" id="productImage" placeholder="https://..." required>
                        </div>
                        <div class="form-group">
                            <label for="productLink">YesStyle Link</label>
                            <input type="url" id="productLink" placeholder="https://www.yesstyle.com/..." required>
                        </div>
                        <button type="submit" class="cute-button">
                            <span class="button-icon">‚ú®</span> Add Product
                        </button>
                    </form>
                </div>

                <div id="manageProductsTab" class="admin-tab">
                    <div class="products-management">
                        <div class="search-bar">
                            <input type="text" id="searchProducts" placeholder="Search products...">
                        </div>
                        <div id="productsList" class="products-list">
                            <!-- Products will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
        import { getConfig } from './js/config.js'

        let supabase = null;

        class DashboardManager {
            constructor() {
                this.init();
            }

            async init() {
                await this.initializeSupabase();
                await this.checkAuth();
                this.setupEventListeners();
                this.loadProducts();
                this.loadCategories();
            }

            async initializeSupabase() {
                const config = await getConfig();
                supabase = createClient(config.supabaseUrl, config.supabaseKey);
            }

            async checkAuth() {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    window.location.href = 'admin-login.html';
                }
            }

            setupEventListeners() {
                document.getElementById('logoutBtn').addEventListener('click', () => this.handleLogout());
                document.getElementById('productForm').addEventListener('submit', (e) => this.handleProductSubmit(e));
                
                document.querySelectorAll('.admin-nav-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.switchTab(btn.dataset.tab));
                });

                const searchInput = document.getElementById('searchProducts');
                if (searchInput) {
                    searchInput.addEventListener('input', () => this.debounce(() => this.searchProducts(), 300));
                }
            }

            async handleLogout() {
                try {
                    const { error } = await supabase.auth.signOut();
                    if (error) throw error;
                    
                    this.showNotification('Logged out successfully! üëã', 'info');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                } catch (error) {
                    this.showNotification('Logout failed: ' + error.message, 'error');
                }
            }

            async handleProductSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const submitButton = form.querySelector('button[type="submit"]');
                
                try {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<span class="button-icon">‚è≥</span> Processing...';
                    
                    const category = document.getElementById('productCategory').value;
                    if (!category) {
                        throw new Error('Please select a category');
                    }

                    const productData = {
                        name: document.getElementById('productName').value,
                        category: category,
                        price: parseFloat(document.getElementById('productPrice').value),
                        image_url: document.getElementById('productImage').value,
                        product_link: document.getElementById('productLink').value,
                        created_at: new Date().toISOString()
                    };

                    let error;
                    if (submitButton._editId) {
                        ({ error } = await supabase
                            .from('products')
                            .update(productData)
                            .eq('id', submitButton._editId));
                    } else {
                        ({ error } = await supabase
                            .from('products')
                            .insert([productData]));
                    }

                    if (error) throw error;

                    this.showNotification(
                        submitButton._editId ? 'Product updated successfully! üéâ' : 'Product added successfully! ‚ú®', 
                        'success'
                    );
                    
                    form.reset();
                    submitButton._editId = null;
                    submitButton.innerHTML = '<span class="button-icon">‚ú®</span> Add Product';
                    this.loadProducts();
                } catch (error) {
                    this.showNotification(error.message, 'error');
                } finally {
                    submitButton.disabled = false;
                }
            }

            switchTab(tabId) {
                document.querySelectorAll('.admin-nav-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tabId);
                });

                document.querySelectorAll('.admin-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.id === tabId + 'ProductTab');
                });

                if (tabId === 'manage') {
                    this.loadProducts();
                }
            }

            async loadProducts() {
                const productsList = document.getElementById('productsList');
                if (!productsList) return;

                try {
                    productsList.innerHTML = '<div class="loading"></div>';
                    const { data: products, error } = await supabase
                        .from('products')
                        .select('*, categories(name)')
                        .order('created_at', { ascending: false });

                    if (error) throw error;

                    this.renderProductsList(products);
                } catch (error) {
                    this.showNotification('Failed to load products: ' + error.message, 'error');
                    productsList.innerHTML = '<div class="error-state"><p>Failed to load products üò¢</p></div>';
                }
            }

            renderProductsList(products) {
                const productsList = document.getElementById('productsList');
                if (!products.length) {
                    productsList.innerHTML = '<div class="empty-state"><p>No products found üê∞</p></div>';
                    return;
                }

                productsList.innerHTML = products.map(product => `
                    <div class="product-item" data-id="${product.id}">
                        <a href="${product.product_link}" target="_blank" class="product-item-link"></a>
                        <img src="${product.image_url}" alt="${product.name}" 
                             onerror="this.src='./assets/placeholder.svg'">
                        <div class="product-item-info">
                            <h3>${product.name}</h3>
                            <p class="product-price">$${product.price.toFixed(2)}</p>
                            <a href="${product.product_link}" target="_blank" class="product-link">View on YesStyle</a>
                        </div>
                        <div class="product-item-actions">
                            <button class="action-btn edit-btn" onclick="editProduct('${product.id}')">‚úèÔ∏è</button>
                            <button class="action-btn delete-btn" onclick="deleteProduct('${product.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');
            }

            async searchProducts() {
                const query = document.getElementById('searchProducts').value.toLowerCase();
                
                const { data: products, error } = await supabase
                    .from('products')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    this.showNotification('Search failed: ' + error.message, 'error');
                    return;
                }

                const filteredProducts = products.filter(product =>
                    product.name.toLowerCase().includes(query)
                );

                this.renderProductsList(filteredProducts);
            }

            async loadCategories() {
                try {
                    const { data: categories, error } = await supabase
                        .from('categories')
                        .select('*')
                        .order('name', { ascending: true });

                    if (error) throw error;

                    this.renderCategoryOptions(categories);
                    this.renderCategoryList(categories);
                } catch (error) {
                    this.showNotification('Failed to load categories: ' + error.message, 'error');
                }
            }

            renderCategoryOptions(categories) {
                const categorySelect = document.getElementById('productCategory');
                const categoryFilter = document.getElementById('categoryFilterAdmin');

                if (!categories.length) return;

                categorySelect.innerHTML = '<option value="">Select a category</option>' + categories.map(category => `
                    <option value="${category.id}">${category.name}</option>
                `).join('');

                categoryFilter.innerHTML = '<option value="">All Categories</option>' + categories.map(category => `
                    <option value="${category.id}">${category.name}</option>
                `).join('');
            }

            renderCategoryList(categories) {
                const categoryList = document.getElementById('categoryList');
                if (!categories.length) {
                    categoryList.innerHTML = '<div class="empty-state"><p>No categories found üê∞</p></div>';
                    return;
                }

                categoryList.innerHTML = categories.map(category => `
                    <div class="category-item" data-id="${category.id}">
                        <span>${category.name}</span>
                        <button class="action-btn delete-btn" onclick="deleteCategory('${category.id}')">üóëÔ∏è</button>
                    </div>
                `).join('');
            }

            showNotification(message, type) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        }

        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new DashboardManager();
        });

        // Make these functions available globally for the onclick handlers
        window.editProduct = async (id) => {
            try {
                const { data: product, error } = await supabase
                    .from('products')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                document.getElementById('productName').value = product.name;
                document.getElementById('productCategory').value = product.category;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productImage').value = product.image_url;
                document.getElementById('productLink').value = product.product_link;

                const submitButton = document.getElementById('productForm').querySelector('button[type="submit"]');
                submitButton.innerHTML = '<span class="button-icon">‚úèÔ∏è</span> Update Product';
                submitButton._editId = id;

                document.querySelector('[data-tab="add"]').click();
            } catch (error) {
                showNotification('Failed to load product: ' + error.message, 'error');
            }
        };

        window.deleteProduct = async (id) => {
            if (!confirm('Are you sure you want to delete this product? üóëÔ∏è')) return;

            try {
                const { error } = await supabase
                    .from('products')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                showNotification('Product deleted successfully! üóëÔ∏è', 'success');
                document.querySelector('.admin-nav-btn[data-tab="manage"]').click();
            } catch (error) {
                showNotification('Failed to delete product: ' + error.message, 'error');
            }
        };

        window.showNewCategoryInput = () => {
            document.getElementById('newCategoryInput').style.display = 'block';
        };

        window.addNewCategory = async () => {
            const newCategoryName = document.getElementById('newCategory').value.trim();
            if (!newCategoryName) return;

            try {
                const { data: category, error } = await supabase
                    .from('categories')
                    .insert([{ name: newCategoryName }])
                    .single();

                if (error) throw error;

                showNotification('Category added successfully! ‚ú®', 'success');
                document.getElementById('newCategory').value = '';
                document.getElementById('newCategoryInput').style.display = 'none';
                new DashboardManager().loadCategories();
            } catch (error) {
                showNotification('Failed to add category: ' + error.message, 'error');
            }
        };

        window.deleteCategory = async (id) => {
            if (!confirm('Are you sure you want to delete this category? üóëÔ∏è')) return;

            try {
                const { error } = await supabase
                    .from('categories')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                showNotification('Category deleted successfully! üóëÔ∏è', 'success');
                new DashboardManager().loadCategories();
            } catch (error) {
                showNotification('Failed to delete category: ' + error.message, 'error');
            }
        };

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>